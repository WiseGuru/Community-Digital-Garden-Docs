<button id="theme-toggle" class="btn" type="button" aria-label="Toggle color theme">🌙</button>

<script>
(function () {
  // Wait for DOM and Just the Docs to be ready
  function initThemeToggle() {
    // Check if jtd object exists
    if (typeof jtd === 'undefined' || typeof jtd.setTheme !== 'function') {
      setTimeout(initThemeToggle, 100);
      return;
    }

    function apply(theme) {
      jtd.setTheme(theme);
      localStorage.setItem('jtd-theme', theme);
      updateIcon(theme);
      // Also update the document class for immediate visual feedback
      document.documentElement.setAttribute('data-color-mode', theme);
    }

    function updateIcon(theme) {
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      btn.textContent = theme === 'dark' ? '☀️' : '🌙';
      btn.setAttribute('aria-pressed', theme === 'dark');
    }

    // 1) Load saved theme, else match system preference
    let theme = localStorage.getItem('jtd-theme');
    if (!theme) {
      const prefersDark = window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches;
      theme = prefersDark ? 'dark' : 'light';
    }
    apply(theme);

    // 2) Listen for manual toggle
    const toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const current = localStorage.getItem('jtd-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        sessionStorage.setItem('jtd-theme-manual', '1');
        apply(next);
      });
    }

    // 3) Follow system changes unless user toggled this session
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    if (mq.addEventListener) {
      mq.addEventListener('change', (e) => {
        const manual = sessionStorage.getItem('jtd-theme-manual') === '1';
        if (!manual) {
          apply(e.matches ? 'dark' : 'light');
        }
      });
    }

    // 4) Add color-scheme meta for browser UI
    if (!document.querySelector('meta[name="color-scheme"]')) {
      const meta = document.createElement('meta');
      meta.name = 'color-scheme';
      meta.content = 'light dark';
      document.head.appendChild(meta);
    }
  }

  // Start initialization when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  } else {
    initThemeToggle();
  }
})();
</script>
